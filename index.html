<!DOCTYPE html>
<html>
    <head>
        <title>SMART on FHIR Cholesterol Viewer</title>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
    </head>
    <body>
        <h4>Current Patient</h4>
        <div id="patient">Loading...</div>
        <br/>
        <h4>Cholesterol Test Results</h4>
        <div id="chart">Loading...</div>

        <script type="text/javascript">
            FHIR.oauth2.ready().then(function(client) {

                // Render patient info
                client.patient.read().then(
                    function(pt) {
                        document.getElementById("patient").innerText = JSON.stringify(pt, null, 4);

                        const patientId = client.patient.id;
                        const loincCodes = [
                            { code: "2093-3", label: "Total Cholesterol" },
                            { code: "13457-7", label: "LDL Cholesterol" },
                            { code: "2085-9", label: "HDL Cholesterol" },
                            { code: "2571-8", label: "Triglycerides" }
                        ];

                        const query = loincCodes.map(c => `http://loinc.org|${c.code}`).join(',');
                        client.request(`Observation?patient=${patientId}&code=${query}`)
                            .then(observations => {
                                if (!observations.entry || observations.entry.length === 0) {
                                    document.getElementById("chart").innerText = "No cholesterol test results found.";
                                    return;
                                }

                                const results = [];
                                observations.entry.forEach(entry => {
                                    const obs = entry.resource;
                                    if (obs.valueQuantity) {
                                        const loincCode = obs.code.coding[0].code;
                                        const match = loincCodes.find(l => l.code === loincCode);
                                        if (match) {
                                            results.push({
                                                name: match.label,
                                                value: obs.valueQuantity.value,
                                                unit: obs.valueQuantity.unit
                                            });
