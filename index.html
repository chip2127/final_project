<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SMART on FHIR Cholesterol & Activity App</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        #patient, #cholesterol, #activity {
            font-family: Monaco, monospace;
            white-space: pre;
            font-size: 13px;
            height: 30vh;
            overflow: scroll;
            border: 1px solid #CCC;
        }
        #chart {
            height: 400px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h4>Current Patient</h4>
    <div id="patient">Loading...</div>
    <br/>
    <h4>Cholesterol Test Results</h4>
    <div id="cholesterol">Loading...</div>
    <br/>
    <h4>Moderate Activity (Minutes)</h4>
    <div id="activity">Loading...</div>
    <br/>
    <h4>Cholesterol & Activity Chart</h4>
    <div id="chart">Loading...</div>

    <script type="text/javascript">
        FHIR.oauth2.ready().then(function(client) {

            let cholesterolResults = [];
            let activityResult = null;

            function renderChart() {
                if (!cholesterolResults.length || activityResult === null) return;

                const chartData = cholesterolResults.map(res => ({
                    name: res.label,
                    y: res.value
                }));

                chartData.push({
                    name: "Moderate Activity (min)",
                    y: activityResult.value
                });

                Highcharts.chart('chart', {
                    chart: { type: 'column' },
                    title: { text: 'Cholesterol & Activity Overview' },
                    xAxis: {
                        type: 'category',
                        title: { text: 'Measurement Type' }
                    },
                    yAxis: {
                        title: { text: 'Value' }
                    },
                    series: [{
                        name: 'Measurements',
                        data: chartData
                    }]
                });
            }

            // --- Patient Info ---
            client.patient.read().then(
                function(pt) {
                    document.getElementById("patient").innerText = JSON.stringify(pt, null, 4);
                },
                function(error) {
                    document.getElementById("patient").innerText = error.stack;
                }
            );

            // --- Cholesterol Section ---
            const cholesterolCodes = [
                { code: "2093-3", label: "Total Cholesterol" },
                { code: "13457-7", label: "LDL Cholesterol" },
                { code: "2085-9", label: "HDL Cholesterol" },
                { code: "2571-8", label: "Triglycerides" }
            ];

            const cholesterolQuery = cholesterolCodes.map(c => `http://loinc.org|${c.code}`).join(',');

            client.request(`/Observation?patient=${client.patient.id}&code=${cholesterolQuery}`)
                .then(function(observations) {
                    if (!observations.entry || observations.entry.length === 0) {
                        document.getElementById("cholesterol").innerText = "No cholesterol test results found for this patient.";
                        return;
                    }

                    const results = observations.entry.map(entry => {
                        const obs = entry.resource;
                        const code = obs.code.coding[0].code;
                        const match = cholesterolCodes.find(l => l.code === code);
                        const label = match ? match.label : code;
                        const value = obs.valueQuantity?.value;
                        const unit = obs.valueQuantity?.unit;
                        const date = obs.effectiveDateTime || "Unknown Date";
                        if (value != null) {
                            cholesterolResults.push({ label, value });
                        }
                        return `${label}: ${value} ${unit} (${date})`;
                    });

                    document.getElementById("cholesterol").innerText = results.join("\n");
                    renderChart();
                })
                .catch(function(error) {
                    console.error("Error fetching cholesterol data:", error);
                    document.getElementById("cholesterol").innerText = "No cholesterol test results found for this patient.";
                });

            // --- Daily Activity Section ---
            const activityCode = "55411-3";
            const activityLabel = "Moderate Activity Minutes";

            client.request(`/Observation?patient=${client.patient.id}&code=http://loinc.org|${activityCode}`)
                .then(function(observations) {
                    if (!observations.entry || observations.entry.length === 0) {
                        document.getElementById("activity").innerText = "No activity results found for this patient.";
                        return;
                    }

                    const results = observations.entry.map(entry => {
                        const obs = entry.resource;
                        const value = obs.valueQuantity?.value;
                        const unit = obs.valueQuantity?.unit;
                        const date = obs.effectiveDateTime || "Unknown Date";
                        if (value != null && activityResult === null) {
                            activityResult = { value };
                        }
                        return `${activityLabel}: ${value} ${unit} (${date})`;
                    });

                    document.getElementById("activity").innerText = results.join("\n");
                    renderChart();
                })
                .catch(function(error) {
                    console.error("Error fetching activity data:", error);
                    document.getElementById("activity").innerText = "No activity results found for this patient.";
                });

        }).catch(console.error);
    </script>
</body>
</html>





